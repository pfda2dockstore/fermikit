# Generated by precisionFDA exporter (v1.0.3) on 2018-06-14 02:14:19 +0000
# The asset download links in this file are valid only for 24h.

# Exported app: fermikit, revision: 8, authored by: mike.lin
# https://precision.fda.gov/apps/app-BvJPP100469368x7QvJkKG9Y

# For more information please consult the app export section in the precisionFDA docs

# Start with Ubuntu 14.04 base image
FROM ubuntu:14.04

# Install default precisionFDA Ubuntu packages
RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
	aria2 \
	byobu \
	cmake \
	cpanminus \
	curl \
	dstat \
	g++ \
	git \
	htop \
	libboost-all-dev \
	libcurl4-openssl-dev \
	libncurses5-dev \
	make \
	perl \
	pypy \
	python-dev \
	python-pip \
	r-base \
	ruby1.9.3 \
	wget \
	xz-utils

# Install default precisionFDA python packages
RUN pip install \
	requests==2.5.0 \
	futures==2.2.0 \
	setuptools==10.2

# Add DNAnexus repo to apt-get
RUN /bin/bash -c "echo 'deb http://dnanexus-apt-prod.s3.amazonaws.com/ubuntu trusty/amd64/' > /etc/apt/sources.list.d/dnanexus.list"
RUN /bin/bash -c "echo 'deb http://dnanexus-apt-prod.s3.amazonaws.com/ubuntu trusty/all/' >> /etc/apt/sources.list.d/dnanexus.list"
RUN curl https://wiki.dnanexus.com/images/files/ubuntu-signing-key.gpg | apt-key add -

# Install app-specific Ubuntu packages
RUN DEBIAN_FRONTEND=noninteractive apt-get update && apt-get install -y \
	pigz

# Download app assets
RUN curl https://dl.dnanex.us/F/D/VGyfpv63gbbyFqY1K1JbQB82y52BpXB3V6pbXxP6/bcftools-1.3.tar.gz | tar xzf - -C / --no-same-owner --no-same-permissions
RUN curl https://dl.dnanex.us/F/D/Qb1q2J3pVPqQ32yXbK2qfzB22Gz27vP006zpJbvq/samtools-1.3.tar.gz | tar xzf - -C / --no-same-owner --no-same-permissions
RUN curl https://dl.dnanex.us/F/D/Z3y9XQ84ZZJP3Pyj1kk5FPqX14544z5kyQ4Y8gkB/fermikit-6fc8bbb3.tar.gz | tar xzf - -C / --no-same-owner --no-same-permissions

# Download helper executables
RUN curl https://dl.dnanex.us/F/D/0K8P4zZvjq9vQ6qV0b6QqY1z2zvfZ0QKQP4gjBXp/emit-1.0.tar.gz | tar xzf - -C /usr/bin/ --no-same-owner --no-same-permissions
RUN curl https://dl.dnanex.us/F/D/bByKQvv1F7BFP3xXPgYXZPZjkXj9V684VPz8gb7p/run-1.2.tar.gz | tar xzf - -C /usr/bin/ --no-same-owner --no-same-permissions

# Write app spec and code to root folder
RUN ["/bin/bash","-c","echo -E \\{\\\"spec\\\":\\{\\\"input_spec\\\":\\[\\{\\\"name\\\":\\\"reads1\\\",\\\"class\\\":\\\"file\\\",\\\"optional\\\":false,\\\"label\\\":\\\"\\\",\\\"help\\\":\\\"gzipped\\ FASTQ\\ reads\\\"\\},\\{\\\"name\\\":\\\"reads2\\\",\\\"class\\\":\\\"file\\\",\\\"optional\\\":true,\\\"label\\\":\\\"\\\",\\\"help\\\":\\\"gzipped\\ FASTQ\\ reads\\\"\\},\\{\\\"name\\\":\\\"reference_genome\\\",\\\"class\\\":\\\"file\\\",\\\"optional\\\":false,\\\"label\\\":\\\"\\\",\\\"help\\\":\\\"gzipped\\ FASTA\\ reference\\ genome\\\",\\\"default\\\":\\\"file-BqJxkVj09YXZ3628Bxb337PQ\\\"\\},\\{\\\"name\\\":\\\"read_length\\\",\\\"class\\\":\\\"int\\\",\\\"optional\\\":false,\\\"label\\\":\\\"\\\",\\\"help\\\":\\\"\\\",\\\"default\\\":150\\},\\{\\\"name\\\":\\\"estimated_genome_size\\\",\\\"class\\\":\\\"int\\\",\\\"optional\\\":false,\\\"label\\\":\\\"\\\",\\\"help\\\":\\\"\\\",\\\"default\\\":3200000000\\},\\{\\\"name\\\":\\\"output_name\\\",\\\"class\\\":\\\"string\\\",\\\"optional\\\":false,\\\"label\\\":\\\"\\\",\\\"help\\\":\\\"\\\",\\\"default\\\":\\\"genome\\\"\\}\\],\\\"output_spec\\\":\\[\\{\\\"name\\\":\\\"unitigs_bam\\\",\\\"class\\\":\\\"file\\\",\\\"optional\\\":false,\\\"label\\\":\\\"\\\",\\\"help\\\":\\\"\\\"\\},\\{\\\"name\\\":\\\"raw_vcf\\\",\\\"class\\\":\\\"file\\\",\\\"optional\\\":false,\\\"label\\\":\\\"\\\",\\\"help\\\":\\\"\\\"\\},\\{\\\"name\\\":\\\"filtered_vcf\\\",\\\"class\\\":\\\"file\\\",\\\"optional\\\":false,\\\"label\\\":\\\"\\\",\\\"help\\\":\\\"\\\"\\},\\{\\\"name\\\":\\\"sv_vcf\\\",\\\"class\\\":\\\"file\\\",\\\"optional\\\":false,\\\"label\\\":\\\"\\\",\\\"help\\\":\\\"\\\"\\},\\{\\\"name\\\":\\\"logs\\\",\\\"class\\\":\\\"file\\\",\\\"optional\\\":false,\\\"label\\\":\\\"\\\",\\\"help\\\":\\\"\\\"\\}\\],\\\"internet_access\\\":false,\\\"instance_type\\\":\\\"himem-16\\\"\\},\\\"assets\\\":\\[\\\"file-BpBpxqQ0qVb1bYP12Q804g81\\\",\\\"file-BpBpb580qVbPkG0711FzfBYk\\\",\\\"file-BvJPKQ809YXgx9gxj0gj2y79\\\"\\],\\\"packages\\\":\\[\\\"pigz\\\"\\]\\} \u003e /spec.json"]
RUN ["/bin/bash","-c","echo -E \\{\\\"code\\\":\\\"read_reads\\=\\$\\(find\\ /work/in\\ -type\\ f\\ -path\\ \\\\\\\"/work/in/reads\\*/\\*\\\\\\\"\\ \\|\\ xargs\\ -n\\ 100\\ echo\\ zcat\\)\\\\n\\\\n/fermi.kit/fermi2.pl\\ unitig\\ \\\\\\\"-s\\$\\{estimated_genome_size\\}\\\\\\\"\\ -t\\$\\(nproc\\)\\ \\\\\\\"-l\\$\\{read_length\\}\\\\\\\"\\ -p\\ genome\\ \\\\\\\"\\$read_reads\\\\\\\"\\ \\\\u003e\\ genome.mak\\\\ncat\\ genome.mak\\\\nmake\\ -f\\ genome.mak\\\\nzcat\\ /work/in/reference_genome/\\*\\ \\\\u003e\\ reference_genome.fa\\\\nsamtools\\ faidx\\ reference_genome.fa\\\\n/fermi.kit/bwa\\ index\\ reference_genome.fa\\\\n/fermi.kit/run-calling\\ -t\\$\\(nproc\\)\\ reference_genome.fa\\ genome.mag.gz\\ \\|\\ sh\\\\n\\\\nls\\ -lh\\\\n\\\\nmv\\ genome.srt.bam\\ \\\\\\\"\\$\\{output_name\\}.bam\\\\\\\"\\\\nemit\\ unitigs_bam\\ \\\\\\\"\\$\\{output_name\\}.bam\\\\\\\"\\\\n\\\\nmv\\ genome.raw.vcf.gz\\ \\\\\\\"\\$\\{output_name\\}.raw.vcf.gz\\\\\\\"\\\\nemit\\ raw_vcf\\ \\\\\\\"\\$\\{output_name\\}.raw.vcf.gz\\\\\\\"\\\\n\\\\nmv\\ genome.flt.vcf.gz\\ \\\\\\\"\\$\\{output_name\\}.flt.vcf.gz\\\\\\\"\\\\nemit\\ filtered_vcf\\ \\\\\\\"\\$\\{output_name\\}.flt.vcf.gz\\\\\\\"\\\\n\\\\nmv\\ genome.sv.vcf.gz\\ \\\\\\\"\\$\\{output_name\\}.sv.vcf.gz\\\\\\\"\\\\nemit\\ sv_vcf\\ \\\\\\\"\\$\\{output_name\\}.sv.vcf.gz\\\\\\\"\\\\n\\\\nzip\\ \\\\\\\"\\$\\{output_name\\}.fermikit.logs.zip\\\\\\\"\\ \\*.log\\\\nemit\\ logs\\ \\\\\\\"\\$\\{output_name\\}.fermikit.logs.zip\\\\\\\"\\\\n\\\"\\} | python -c 'import sys,json; print json.load(sys.stdin)[\"code\"]' \u003e /script.sh"]

# Create directory /work and set it to $HOME and CWD
RUN mkdir -p /work
ENV HOME="/work"
WORKDIR /work

# Set entry point to container
ENTRYPOINT ["/usr/bin/run"]

VOLUME /data
VOLUME /work